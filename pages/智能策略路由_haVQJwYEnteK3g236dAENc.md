# 智能策略路由

Smart Policy Routing

***

<https://support.huawei.com/enterprise/zh/doc/EDOC1000075601?idPath=7919710|21432787|7923148|9858988|6078839>

[示例](http://localhost:7891/newhdx.cgi?fe=1\&lib=AZI0519H\&v=15\&tocLib=AZI0519H\&tocV=15\&id=dc_fd_pbr_0006\&tocURL=resources%2fdc%2fdc%5ffd%5fpbr%5f0006%2ehtml\&p=t\&ui=3\&keyword=%u8def%u7531%u8d1f%u8f7d%u5747%u8861 "示例")

# 智能策略路由

智能策略路由是基于业务需求的策略路由，通过匹配链路质量和网络业务对链路质量的需求，实现智能选路。

#### 产生背景

随着网络业务需求的多样化，业务数据的集中放置，链路质量对网络业务越来越重要。越来越多的用户把关注点从网络的连通性转移到业务的可用性上，如业务的可获得性、响应速度和业务质量等。这些复杂的业务需求给传统的基于逐跳的路由协议提出了挑战，它们无法感知链路的质量和业务的需求，所以带给用户的业务体验也得不到保障，即使路由可达，但链路质量可能已经很差甚至无法正常转发报文了。智能策略路由SPR（Smart Policy Routing）就是在这一背景下产生的一种策略路由，它可以主动探测链路质量并匹配业务的需求，从而选择一条最优链路转发业务数据，可以有效的避免网络黑洞、网络震荡等问题。

#### 业务区分

SPR支持通过以下属性对业务进行区分：

-   根据协议类型区分：IP，TCP，UDP，GRE，IGMP，IPINIP，OSPF，ICMP。
-   根据报文应用区分：DSCP，TOS，IP Precedence，Fragment，VPN，TCP-flag。
-   根据报文信息区分：Source IP Address，Destination IP Address，Protocol，Source Port，Destination Port，Source IP Prefix，Destination IP Prefix。

不同的业务对链路的时延D（Delay）、抖动时间J（Jitter）、丢包率L（Loss）以及综合度量指标CMI（Composite Measure Indicator）有不同的要求，如果业务对链路的某一项质量参数没有要求，就不需要配置该参数的阈值

-   说明：
    -   Delay的最大值为5000毫秒，Jitter的最大值为3000毫秒，Loss的最大值为1000‰，Delay、Jitter和Loss的缺省值分别为其最大值。以上参数值越小表明链路质量越好。
    -   CMI是链路的综合度量指标，计算公式为：CMI=9000–*cmi-method* ，其中\_cmi-method\_缺省定义为：D+J+L。
        -   用户可以根据实际业务需求自定义\_cmi-method\_的公式。例如用户定义\_cmi-method\_ =D+10*J，此时链路的时延为1000毫秒，抖动为10毫秒，则CMI=9000–（D+10*J）=9000–（1000+100）=7900。
        -   CMI计算公式中的Delay、Jitter或Loss参数，如果伴有系数，则它们与系数的乘积不能大于它们的最大值。例如CMI=9000–（10*D+10*J+10*L），此时链路的时延为1000毫秒，抖动为100毫秒，丢包率为10‰。因为Delay=10*1000=10000>5000，所以Delay取其最大值5000，则CMI=9000–（5000+1000+100）= 2900。

#### 探测链路和链路组

探测链路是SPR实现智能选路的基础，每个探测链路都有一个与之相对应的探针，即NQA（Network Quality Analysis）测试例。如果测试失败，则表示对应的探测链路不可用。探测链路通过探针获取链路参数的质量，SPR根据探测链路的链路质量匹配业务需求，从而实现智能选路的需求。

SPR不直接使用探测链路，而是通过链路组的形式使用探测链路。一个探测链路可以加入不同的链路组，同时一个链路组中可以有一条或多条探测链路。

SPR的链路角色分为：主用链路组、备用链路组和逃生链路。SPR中业务无法从主用链路组和备用链路组中找到合适的链路传输数据时可以启用逃生链路。

同一个链路组可以被不同的业务绑定，如链路组1可以作为业务1的主用链路组，同时也可以作为业务2的备用链路组。

![](../image/1rj4dgd3_OGr__-ToLB.bmp)

在业务选路时，如果当前链路上已经部属了业务，则该链路的选择指数将降低，即选择的机率变小，这样宏观上可以达到负载均衡的效果。

#### 切换周期

SPR中切换周期计时器主要用于链路质量不满足业务需求时控制链路切换。

SPR根据[NQA](NQA_wJHqqdjS4Bujoh8sCpcfk4.md "NQA")探测结果判断链路是否满足业务需求，SPR会定期获取NQA的探测结果，如果某次获取的NQA探测结果不满足业务需求，则切换周期计时器开始计时。在开始计时后切换周期到达之前，如果某次获取的探测结果满足了业务需求，则切换周期计时器清零，直到下次获取到不满足业务需求的探测结果时会再次开始计时。如果计时器开始计时后，在切换周期内获取到的探测结果都不能满足业务需求，则SPR切换链路。

#### 振荡抑制周期

某些情况下，网络会出现时好时坏的情况，从而导致SPR频繁切换链路，严重影响业务体验。SPR的抑制振荡功能可以有效的避免此类情况产生。

振荡抑制周期默认情况下不生效，周期值由用户自己配置。SPR切换链路后，振荡抑制周期计时器开始计时，如果业务驻留链路的时间没有达到振荡抑制周期的时间，则SPR不会执行链路切换。振荡抑制周期超时后，如果在一个切换周期内链路还是不满足业务需求，则SPR将切换链路；如果在一个切换周期内链路质量变好，满足业务需求，则SPR不会切换链路
